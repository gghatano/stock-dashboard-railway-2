# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## プロジェクト概要

Claude Code Software Development Driver (CCSDD) テンプレート。スラッシュコマンドで役割を切り替えるエージェントシステムとGit Worktreeによる並行開発ワークフローを提供する。

## 最重要ルール

### 実装権限

| コマンド | 役割 | 実装権限 | 定義ファイル |
|---------|------|---------|-------------|
| （なし） | 技術アドバイザー | ❌ | `.claude/skills/technical-advisor/` |
| `/pm` | タスク管理・進捗確認 | ❌ | `.claude/commands/pm.md` |
| `/arch` | タスク分割・詳細設計 | ❌ | `.claude/commands/arch.md` |
| `/eng` | **実装の実行** | ✅ | `.claude/commands/eng.md` |
| `/rev` | コードレビュー | ❌ | `.claude/commands/rev.md` |
| `/knowledge` | 知見の追加・管理 | ❌ | `.claude/commands/knowledge.md` |

**実装が必要な場合は必ず `/eng` を使用する。**

### コンテキスト分離

- **各Worktreeは独立したVSCodeウィンドウで開く**
- 新しい機能の実装開始時は新しいチャットセッションを推奨
- 複数機能を同時に開発する場合、コンテキストの混同に注意

## カスタムコマンドの使い方

### /pm - プロジェクトマネージャー
```
/pm                           # 現在のタスク状況を確認
/pm 次のタスクは？             # 次に着手すべきタスクを確認
/pm タスク1.2を開始            # タスク開始を記録
/pm タスク1.2が完了            # タスク完了を記録
```

**自動で行うこと:**
- `doc/開発方針.md` を読み込んでタスク一覧を確認
- タスクステータスの更新内容を提案
- 次のステップ（Worktree作成、設計、実装）を案内

### /arch - アーキテクト
```
/arch タスク1.2の設計を作成して
/arch ユーザー認証機能の詳細設計
```

**自動で行うこと:**
- 標準フォーマットで設計書を出力
- サブタスク分割、ファイル構成、実装方針を提示
- 完了条件を明確化
- 設計書の保存を提案

**出力フォーマット（標準化済み）:**
1. 概要
2. サブタスク分割（表形式）
3. ファイル構成（ツリー形式）
4. 実装方針
5. 実装例（疑似コード）
6. 完了条件
7. 注意事項

### /eng - エンジニア
```
/eng タスク1.2を実装して
/eng ユーザー認証APIを実装して（設計書参照: doc/tasks/task-1.2.md）
/eng レビュー指摘を修正して: [指摘内容]
```

**自動で行うこと:**
- 実装前チェックリストを確認
- 実装中の進捗を報告
- 実装完了時に標準フォーマットで報告
- 次のステップ（テスト、コミット、レビュー依頼、タスク完了記録）を案内

**実装完了時の自動案内:**
```
✅ 実装完了

📋 次のステップ
1. 動作確認: [テストコマンド]
2. コミット: git add . && git commit -m "..."
3. レビュー: /rev worktrees/[機能名] をレビューして
4. 完了記録: /pm [タスク名]が完了しました
```

### /rev - レビュアー
```
/rev worktrees/user-auth をレビューして
/rev worktrees/user-auth を再レビュー
```

**自動で行うこと:**
- チェックリストに基づいて自動確認
  - コード品質、機能、セキュリティ、パフォーマンス、テスト
- 重要度別（高/中/低）に指摘を分類
- 良かった点もフィードバック
- 修正が必要な場合、`/eng` への依頼方法を案内

## 開発ワークフロー

```
1. /pm でタスク確認 → 次に何をすべきか明確化
2. /arch で詳細設計 → 実装方針・ファイル構成を決定
3. Worktree作成 → 独立した開発環境を用意
4. /eng で実装 → 設計に従ってコード作成
5. /rev でレビュー → 品質チェック
6. マージ & クリーンアップ
```

### 各フェーズのチェックポイント

#### 1. タスク確認後 (`/pm`)
- [ ] 次のタスクが明確になった
- [ ] 依存関係・ブロッカーを確認した
- [ ] タスクのステータスを IN_PROGRESS に更新した

#### 2. 設計完了後 (`/arch`)
- [ ] ファイル構成が決まった
- [ ] 実装方針が明確になった
- [ ] 完了条件が定義された
- [ ] 設計を `doc/tasks/` に保存した（必要に応じて）

#### 3. 実装完了後 (`/eng`)
- [ ] すべてのコードが実装された
- [ ] テストが作成された
- [ ] 動作確認を実施した
- [ ] コミットした

#### 4. レビュー完了後 (`/rev`)
- [ ] 指摘事項を修正した
- [ ] 再レビューで承認を得た
- [ ] マージ準備完了

## Worktree管理

```bash
# 作成
./scripts/worktree-manager.sh create <feature-name>

# 一覧
./scripts/worktree-manager.sh list

# 状態確認
./scripts/worktree-manager.sh status <feature-name>

# mainと同期
./scripts/worktree-manager.sh sync <feature-name>

# 削除
./scripts/worktree-manager.sh cleanup <feature-name>
```

## ベストプラクティス

### 効率的なプロンプトの書き方

#### 良い例
```
/eng ユーザー認証APIを実装して

以下の設計に従ってください：
- ファイル: backend/app/api/auth.py
- エンドポイント: POST /api/auth/login
- 仕様: doc/仕様書.md の認証セクション参照
```

#### 悪い例
```
認証機能を作って
```
→ `/eng` がないため実装されない。設計も不明確。

### スキル使用の判断基準

| やりたいこと | 使うコマンド |
|------------|-------------|
| 次に何をすべきか知りたい | `/pm` |
| 実装方針を決めたい | `/arch` |
| コードを書きたい・修正したい | `/eng` |
| 実装の品質を確認したい | `/rev` |
| 技術的な質問をしたい | （なし） |

### よくある間違いと対策

| 間違い | 対策 |
|-------|------|
| `/eng`なしで実装を依頼 | 「〜を作って」→「`/eng` 〜を実装して」 |
| 設計なしで実装開始 | 先に `/arch` で設計を作成 |
| 同じウィンドウで複数機能を開発 | Worktreeごとに別ウィンドウを開く |
| レビューなしでマージ | 必ず `/rev` でレビュー |
| タスク完了を記録しない | `/pm` でステータスを DONE に更新 |

### 大きなタスクの進め方

1. **分割**: `/arch` でサブタスクに分割
2. **順序**: 依存関係を考慮して順序決定
3. **実装**: 各サブタスクを `/eng` で個別に実装
4. **確認**: 各サブタスク完了時に動作確認
5. **統合**: 全サブタスク完了後に統合テスト

### コンテキストの提供

Claude Codeに依頼する際、必要なコンテキストを明示的に提供する：

```
/eng タスク1.3を実装して

参照ドキュメント:
- 仕様: doc/仕様書.md のセクション4
- 設計: doc/tasks/task-1.3.md
- 関連コード: backend/app/services/existing_service.py
```

## タスク管理

### タスク一覧の場所
`doc/開発方針.md`

### タスクステータス
- 🔵 **TODO**: 未着手
- 🟡 **IN_PROGRESS**: 作業中
- 🟢 **DONE**: 完了
- ⚪ **HOLD**: 保留中
- 🔴 **BLOCKED**: ブロック中

## 参照ドキュメント

- `doc/仕様書.md` - システム仕様（実装時に必ず参照）
- `doc/開発方針.md` - フェーズ別タスク計画
- `doc/project_knowledge.md` - プロジェクト固有の技術知見
- `doc/worktree-workflow.md` - Worktree開発フロー詳細
- `KNOWLEDGE_GUIDE.md` - 知見の配置ガイド

## コーディング規約

### Python (Backend)
- PEP 8準拠、型ヒント必須、Docstring記載
- 配置: `backend/app/`

### JavaScript/TypeScript (Frontend)
- ESLint推奨設定、関数コンポーネントのみ
- 配置: `frontend/src/`

## レビュー重要度

- **🔴 高**: 必須修正（セキュリティ、動作不良、仕様違反）
- **🟡 中**: 推奨修正（可読性、テスト不足、エラー処理）
- **🟢 低**: 改善提案（リファクタリング、コメント）

## トラブルシューティング

### 意図しない実装が始まった
→ 即座に中断し、`/eng` で明示的に依頼し直す

### コンテキストが混乱している
→ 新しいチャットセッションを開始し、必要なコンテキストを再提供

### 設計と実装が乖離した
→ `/arch` で設計を見直すか、`/rev` で差異を確認

## ディレクトリ構造

```
.claude/
├── commands/           # カスタムスラッシュコマンド
│   ├── pm.md          # /pm コマンド定義
│   ├── arch.md        # /arch コマンド定義
│   ├── eng.md         # /eng コマンド定義
│   └── rev.md         # /rev コマンド定義
└── skills/             # スキル定義（詳細な役割説明）
    ├── technical-advisor/
    ├── project-management/
    ├── architecture-design/
    ├── implementation/
    └── code-review/

doc/
├── 仕様書.md           # システム仕様
├── 開発方針.md         # タスク一覧・進捗管理
├── project_knowledge.md # プロジェクト固有の技術知見
├── tasks/              # タスク別設計書
└── diagrams/           # 図表

scripts/
└── worktree-manager.sh # Worktree管理スクリプト

templates/              # ドキュメントテンプレート
worktrees/              # 並行開発用（.gitignore）
```
