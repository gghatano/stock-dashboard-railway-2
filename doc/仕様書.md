# 株価ダッシュボード システム仕様書

## 1. プロジェクト概要

### 1.1 システム名
株価ダッシュボード（Stock Dashboard）

### 1.2 目的
日本株（日鉄ソリューションズ、小野薬品工業）および米国株（S&P500、FANG+主要銘柄）のリアルタイム株価情報を統合的に表示し、ドル建て/円建ての切り替え機能を提供する。

### 1.3 技術スタック
- **バックエンド**: FastAPI (Python)
- **フロントエンド**: HTMX + Tailwind CSS
- **データソース**: yfinance (Yahoo Finance API)
- **タイムゾーン**: pytz (日本標準時対応)
- **デプロイ**: Railway

### 1.4 主要機能
1. リアルタイム株価表示
2. 前日比・騰落率の表示
3. 出来高情報の表示
4. 直近10日間の価格推移チャート（線グラフ）
5. 30秒ごとの自動更新（HTMX polling）
6. メモリベースキャッシュ機構（30秒TTL）
7. ドル円為替レート取得
8. **通貨表示切り替え**（ドル建て ⇄ 円建て）
9. エラーハンドリングとフォールバック表示
10. ヘルスチェックエンドポイント

---

## 2. 監視銘柄仕様

### 2.1 日本株

| ティッカー | 銘柄名 | 市場 | 通貨 | 種類 |
|-----------|--------|------|------|------|
| 2327.T | 日鉄ソリューションズ | 東京証券取引所 | JPY | 株式 |
| 4528.T | 小野薬品工業 | 東京証券取引所 | JPY | 株式 |

**特徴**:
- 円建て表示のみ
- 通貨切り替えの影響を受けない

### 2.2 米国インデックス

| ティッカー | 名称 | 説明 | 通貨 | 種類 |
|-----------|------|------|------|------|
| ^GSPC | S&P 500 | 米国株式市場の主要500社 | USD | インデックス |

**特徴**:
- ドル建て/円建て表示の切り替え可能
- 出来高は意味が薄いため0または非表示
- ポイント単位の表示

**代替候補**:
- `^IXIC` - NASDAQ Composite
- `^DJI` - Dow Jones Industrial Average
- `^NDX` - NASDAQ-100

### 2.3 FANG+銘柄（米国テック株）

**推奨構成（6銘柄）**:

| ティッカー | 銘柄名 | セクター | 概算時価総額 | 通貨 | 種類 |
|-----------|--------|----------|-------------|------|------|
| AAPL | Apple | テクノロジー | ~$3.0T | USD | 株式 |
| MSFT | Microsoft | テクノロジー | ~$3.0T | USD | 株式 |
| GOOGL | Alphabet (Google) | テクノロジー | ~$1.8T | USD | 株式 |
| AMZN | Amazon | 小売・クラウド | ~$1.7T | USD | 株式 |
| META | Meta Platforms | テクノロジー | ~$1.2T | USD | 株式 |
| NVDA | NVIDIA | 半導体 | ~$2.5T | USD | 株式 |

**選定理由**:
- FANG（Facebook, Amazon, Netflix, Google）の原型 + 主要テック株
- 高い流動性と知名度
- AI・クラウド分野での重要性
- 画面に収まる適切な銘柄数

**拡張候補**:
- NFLX: Netflix
- TSLA: Tesla

### 2.4 為替レート

| ティッカー | 通貨ペア | 用途 |
|-----------|---------|------|
| USDJPY=X | ドル円 | USD銘柄の円建て換算 |

**キャッシュ**: 30秒TTL（株価データと同じ）

### 2.5 最終的な銘柄構成

**合計: 9銘柄**

1. 日本株: 2銘柄
2. 米国インデックス: 1銘柄
3. FANG+: 6銘柄

---

## 3. データ構造仕様

### 3.1 銘柄定義（STOCKS辞書）

```python
STOCKS = {
    # 日本株
    "2327.T": {
        "name": "日鉄ソリューションズ",
        "currency": "JPY",
        "type": "stock",
        "category": "日本株"
    },
    "4528.T": {
        "name": "小野薬品工業",
        "currency": "JPY",
        "type": "stock",
        "category": "日本株"
    },

    # 米国インデックス
    "^GSPC": {
        "name": "S&P 500",
        "currency": "USD",
        "type": "index",
        "category": "インデックス"
    },

    # FANG+（米国テック株）
    "AAPL": {
        "name": "Apple",
        "currency": "USD",
        "type": "stock",
        "category": "FANG+"
    },
    "MSFT": {
        "name": "Microsoft",
        "currency": "USD",
        "type": "stock",
        "category": "FANG+"
    },
    "GOOGL": {
        "name": "Alphabet",
        "currency": "USD",
        "type": "stock",
        "category": "FANG+"
    },
    "AMZN": {
        "name": "Amazon",
        "currency": "USD",
        "type": "stock",
        "category": "FANG+"
    },
    "META": {
        "name": "Meta",
        "currency": "USD",
        "type": "stock",
        "category": "FANG+"
    },
    "NVDA": {
        "name": "NVIDIA",
        "currency": "USD",
        "type": "stock",
        "category": "FANG+"
    }
}
```

### 3.2 株価データ構造

```python
{
    "ticker": str,              # ティッカーシンボル（例: "2327.T", "AAPL"）
    "name": str,                # 銘柄名（例: "日鉄ソリューションズ", "Apple"）
    "currency": str,            # "USD" or "JPY"
    "type": str,                # "stock" or "index"
    "category": str,            # "日本株", "インデックス", "FANG+"
    "current_price": float,     # 現在価格（元通貨）
    "change": float,            # 前日比（元通貨）
    "change_percent": float,    # 騰落率（%）
    "volume": int,              # 出来高
    "chart_data": List[dict],   # チャートデータ（10日分）
    "last_update": str,         # 最終更新時刻（JST）
    "error": bool,              # エラー状態
    "error_message": str        # エラーメッセージ（error=Trueの場合のみ）
}
```

**チャートデータ構造**:
```python
[
    {
        "date": str,     # 日付（例: "01/08"）
        "close": float   # 終値
    },
    # ... 10日分
]
```

### 3.3 為替レートデータ構造

```python
{
    "rate": float,              # ドル円レート（例: 147.52）
    "last_update": str,         # 最終更新時刻（JST）
    "error": bool               # エラー状態
}
```

### 3.4 キャッシュ構造

```python
_cache = {
    "2327.T": (stock_data_dict, timestamp),
    "4528.T": (stock_data_dict, timestamp),
    "^GSPC": (stock_data_dict, timestamp),
    "AAPL": (stock_data_dict, timestamp),
    # ... 他の銘柄
    "USDJPY=X": (exchange_rate_dict, timestamp),  # 為替レート
}
```

**TTL（Time To Live）**:
- 通常データ: 30秒
- エラーデータ: 10秒

---

## 4. API仕様

### 4.1 エンドポイント一覧

| メソッド | パス | 説明 | レスポンス形式 |
|---------|------|------|---------------|
| GET | `/` | メインダッシュボード | HTML |
| GET | `/api/stocks` | 全銘柄の株価データ | JSON |
| GET | `/api/stocks/partial` | HTMX部分更新用 | HTML |
| GET | `/health` | ヘルスチェック | JSON |
| GET | `/api/cache/clear` | キャッシュクリア（デバッグ用） | JSON |

### 4.2 `/api/stocks` - 全銘柄データ取得

**リクエスト**:
```
GET /api/stocks
```

**レスポンス** (Phase 5以降):
```json
{
    "stocks": [
        {
            "ticker": "2327.T",
            "name": "日鉄ソリューションズ",
            "currency": "JPY",
            "type": "stock",
            "category": "日本株",
            "current_price": 4560.0,
            "change": 63.0,
            "change_percent": 1.4,
            "volume": 204300,
            "chart_data": [
                {"date": "12/29", "close": 4481.0},
                {"date": "12/30", "close": 4422.0},
                {"date": "01/05", "close": 4378.0},
                {"date": "01/06", "close": 4418.0},
                {"date": "01/07", "close": 4458.0},
                {"date": "01/08", "close": 4397.0},
                {"date": "01/09", "close": 4444.0},
                {"date": "01/13", "close": 4444.0},
                {"date": "01/14", "close": 4497.0},
                {"date": "01/15", "close": 4560.0}
            ],
            "last_update": "2026-01-15 22:00:00",
            "error": false
        },
        {
            "ticker": "^GSPC",
            "name": "S&P 500",
            "currency": "USD",
            "type": "index",
            "category": "インデックス",
            "current_price": 4783.23,
            "change": 15.50,
            "change_percent": 0.32,
            "volume": 0,
            "chart_data": [...],
            "last_update": "2026-01-15 22:00:00",
            "error": false
        }
        // ... 他の銘柄
    ],
    "exchange_rate": 147.52,  // Phase 2で追加
    "timestamp": "2026-01-15T22:00:00+09:00"
}
```

### 4.3 `/api/stocks/partial` - HTMX部分更新

**リクエスト**:
```
GET /api/stocks/partial
```

**レスポンス**:
- HTMLフラグメント（`stocks_partial.html`のレンダリング結果）
- HTMXが自動的にDOM更新

### 4.4 `/health` - ヘルスチェック

**リクエスト**:
```
GET /health
```

**レスポンス**:
```json
{
    "status": "healthy",
    "timestamp": "2026-01-15T22:00:00+09:00",
    "cache_size": 9
}
```

### 4.5 `/api/cache/clear` - キャッシュクリア

**リクエスト**:
```
GET /api/cache/clear
```

**レスポンス**:
```json
{
    "message": "Cache cleared: 9 entries removed"
}
```

---

## 5. 通貨表示機能の仕様

### 5.1 表示ルール

| 元通貨 | 表示通貨 | マーク | 小数点桁数 | 例 |
|--------|----------|--------|-----------|-----|
| JPY | JPY | ¥ | 0桁 | ¥4,560 |
| JPY | USD | ¥ | 0桁 | ¥4,560 (変換不要) |
| USD | USD | $ | 2桁 | $4,783.23 |
| USD | JPY | ¥ | 0桁 | ¥705,891 |

### 5.2 換算計算式

**USD → JPY**:
```
円建て価格 = ドル建て価格 × ドル円レート
例: $4,783.23 × 147.52 = ¥705,891
```

**前日比の換算**:
```
円建て前日比 = ドル建て前日比 × ドル円レート
例: $15.50 × 147.52 = ¥2,287
```

**騰落率**:
```
騰落率は通貨に依存しない（%）
例: 0.32% はそのまま
```

### 5.3 チャートデータの換算

USD銘柄を円建て表示する場合:
```python
for point in chart_data:
    point['close_jpy'] = point['close'] * exchange_rate
```

### 5.4 通貨切り替えUI仕様

**トグルスイッチ**:
- 位置: ヘッダー部分（手動更新ボタンの近く）
- 状態: USD / JPY
- デフォルト: USD
- 動作: クリックで即座に切り替え
- 保存: ローカルストレージ（オプション）

**UI配置**:
```
┌─────────────────────────────────────────┐
│  株価ダッシュボード          [USD|JPY]  │
│                      [手動更新] [ヘルス] │
└─────────────────────────────────────────┘
```

### 5.5 通貨表示実装方針

**推奨アプローチ**: クライアントサイド計算

**理由**:
- UXが良い（ページリロードなし）
- サーバー負荷が少ない
- リアルタイムで切り替え可能

**データフロー**:
1. サーバーは元通貨のデータと為替レートを返す
2. JavaScriptがクライアント側で換算計算
3. トグル切り替え時に表示を動的更新

---

## 6. UI/UX仕様

### 6.1 レイアウト

**グリッドシステム**:
```html
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
  <!-- 銘柄カード -->
</div>
```

**レスポンシブブレークポイント**:
- モバイル（~768px）: 1列
- タブレット（768px~1024px）: 2列
- デスクトップ（1024px~）: 3列

### 6.2 銘柄カード

**構成要素**:
1. ヘッダー
   - 銘柄名
   - ティッカーシンボル
2. 価格情報
   - 現在価格（大きく表示）
   - 前日比（色分け：上昇=緑、下降=赤）
   - 騰落率
3. 出来高
4. チャート（線グラフ、10日分）
5. 最終更新時刻

**カラーコード**:
- 上昇: 緑系（`text-green-600`）
- 下降: 赤系（`text-red-600`）
- 変化なし: グレー系（`text-gray-600`）

### 6.3 チャート仕様

**種類**: SVG線グラフ

**特徴**:
- 10日間の終値データ
- グラデーション塗りつぶし
- データポイント表示（ホバーで価格表示）
- グリッド線（横線）
- 日付ラベル

**サイズ**: 高さ160px、幅100%

### 6.4 自動更新

**方式**: HTMX polling

**設定**:
```html
<div id="stocks-container"
     hx-get="/api/stocks/partial"
     hx-trigger="every 30s"
     hx-swap="innerHTML">
```

**更新間隔**: 30秒

**手動更新**: ボタンクリックで即座に更新可能

### 6.5 エラー表示

**エラー時の表示**:
- カード中央に警告アイコン
- エラーメッセージ
- 最終更新時刻
- データは0や空配列で表示

---

## 7. キャッシュ機構仕様

### 7.1 キャッシュ方式

**種類**: メモリベースキャッシュ（Redis不要）

**実装**: Pythonの辞書 + threading.Lock

### 7.2 スレッドセーフティ

**ロック機構**:
```python
_cache_lock = Lock()

# キャッシュへのアクセス時は必ずロックを取得
with _cache_lock:
    _cache[ticker] = (data, timestamp)
```

**重要な注意点**:
- `is_cache_valid()`は内部でロックを取得
- 呼び出し側でロックを保持してはいけない（デッドロック防止）

### 7.3 TTL（Time To Live）

| データ種別 | TTL | 理由 |
|-----------|-----|------|
| 通常データ | 30秒 | API負荷軽減と鮮度のバランス |
| エラーデータ | 10秒 | 復旧の早期検出 |

### 7.4 キャッシュキー

- 株価データ: ティッカーシンボル（例: `"2327.T"`, `"AAPL"`）
- 為替レート: `"USDJPY=X"`

---

## 8. エラーハンドリング仕様

### 8.1 データ取得エラー

**対応**:
1. ログ出力（`logger.error`）
2. `create_error_data()`でエラーデータ生成
3. エラーデータをキャッシュ（短いTTL）
4. UIに適切なエラー表示

**エラーデータ構造**:
```python
{
    "ticker": ticker,
    "name": STOCKS[ticker]["name"],
    "current_price": 0,
    "change": 0,
    "change_percent": 0,
    "volume": 0,
    "chart_data": [],
    "last_update": timestamp_str,
    "error": True,
    "error_message": "データの取得に失敗しました"
}
```

### 8.2 NaN値の処理

**価格データ**:
```python
if math.isnan(current_price) or math.isnan(prev_price):
    logger.error(f"Invalid price data (NaN) for {ticker}")
    return create_error_data(ticker, "価格データに不正な値が含まれています", timestamp_str)
```

**チャートデータ**:
```python
if not math.isnan(close_value):
    chart_data.append({"date": date.strftime("%m/%d"), "close": round(close_value, 2)})
```

**出来高**:
```python
volume = int(volume_value) if not math.isnan(volume_value) else 0
```

### 8.3 為替レート取得エラー

**フォールバック戦略**:
1. キャッシュに有効な過去データがあれば使用
2. なければデフォルト値を使用（例: 150.0）
3. UIに警告メッセージを表示

**デフォルト為替レート**: 150.0円/ドル

---

## 9. パフォーマンス仕様

### 9.1 データ取得

**現状（逐次取得）**:
```python
for ticker in STOCKS.keys():
    data = get_stock_data(ticker)
```

- 9銘柄 × 500-1000ms = 4.5-9秒

**最適化（並列取得）**:
```python
from concurrent.futures import ThreadPoolExecutor

with ThreadPoolExecutor(max_workers=5) as executor:
    results = list(executor.map(get_stock_data, STOCKS.keys()))
```

- 並列取得: 1-2秒

**推奨**: Phase 8で並列化実装

### 9.2 キャッシュヒット率

**目標**:
- 30秒以内の再リクエスト: 100%キャッシュヒット
- ページロード時間: <10ms（キャッシュヒット時）

### 9.3 メモリ使用量

**目安**: <50MB（通常運用時）

---

## 10. セキュリティ仕様

### 10.1 入力検証

**通貨パラメータ**（Phase 6で実装）:
```python
ALLOWED_CURRENCIES = {'USD', 'JPY'}

def validate_currency(currency: str) -> str:
    if currency.upper() not in ALLOWED_CURRENCIES:
        return 'USD'  # デフォルト
    return currency.upper()
```

### 10.2 XSS対策

- Jinja2のオートエスケープ有効（デフォルト）
- ユーザー入力は受け付けない（表示のみ）

### 10.3 認証・認可

- 現バージョンでは不要（公開情報の表示のみ）
- 将来的にユーザー設定機能を追加する場合は要検討

---

## 11. デプロイメント仕様

### 11.1 環境

**プラットフォーム**: Railway

**設定ファイル**: `railway.toml`
```toml
[build]
builder = "NIXPACKS"

[deploy]
startCommand = "uvicorn app:app --host 0.0.0.0 --port $PORT"
restartPolicyType = "ON_FAILURE"
restartPolicyMaxRetries = 10
```

### 11.2 環境変数

**必須**:
- `PORT`: Railwayが自動設定

**不要**:
- yfinanceは認証不要のため、APIキー等は不要

### 11.3 依存パッケージ

**requirements.txt**:
```
fastapi==0.109.0
uvicorn[standard]==0.27.0
jinja2==3.1.3
yfinance==1.0
python-multipart==0.0.6
pytz==2025.2
```

**重要**: yfinance 1.0以上を使用すること（0.2.36は非推奨）

---

## 12. ログ仕様

### 12.1 ログレベル

| レベル | 用途 | 例 |
|--------|------|-----|
| INFO | 正常な処理 | データ取得開始、キャッシュヒット |
| WARNING | 注意が必要だが継続可能 | データなし、NaN検出 |
| ERROR | エラー発生 | API取得失敗、システムエラー |

### 12.2 ログフォーマット

```
%(asctime)s - %(name)s - %(levelname)s - %(message)s
```

**例**:
```
2026-01-15 21:49:54,421 - app - INFO - Fetching fresh data for 2327.T
2026-01-15 21:49:55,326 - app - WARNING - No historical data found for 2327.T
```

---

## 13. テスト仕様

### 13.1 ユニットテスト

**対象**:
- `get_jst_now()`
- `is_cache_valid()`
- `create_error_data()`
- `get_stock_data()`
- `get_exchange_rate()`

**フレームワーク**: pytest

### 13.2 統合テスト

**対象**:
- 全銘柄データ取得
- 為替レート適用
- UI切り替え動作
- キャッシュ動作

### 13.3 スレッドセーフティテスト

**対象**:
- 並行アクセス時のキャッシュ整合性
- ロックのデッドロック検出

---

## 14. 制約事項

### 14.1 データ制約

- **取引時間外**: 前営業日の終値が表示される
- **データ精度**: yfinanceの精度に依存（保証なし）
- **遅延**: リアルタイムではなく若干の遅延あり

### 14.2 技術制約

- **ブラウザ**: モダンブラウザのみサポート（HTMX、SVG対応必須）
- **JavaScript**: 通貨切り替え機能にはJavaScript必須

### 14.3 運用制約

- **API呼び出し**: yfinanceの利用規約に準拠
- **キャッシュTTL**: 30秒未満にしない（API負荷防止）

---

## 15. 用語集

| 用語 | 説明 |
|------|------|
| FANG+ | Facebook(Meta), Apple, Netflix, Google(Alphabet)を中心としたテック株の総称 |
| ティッカーシンボル | 株式市場で使用される銘柄識別コード |
| TTL | Time To Live。キャッシュの有効期限 |
| JST | Japan Standard Time。日本標準時 |
| HTMX | JavaScriptを最小限にしてHTMLでインタラクティブなUIを構築するライブラリ |
| yfinance | Yahoo Finance APIのPythonラッパーライブラリ |
| NaN | Not a Number。数値として無効な値 |
