# 株価ダッシュボード 開発方針

## プロジェクト概要

日本株・米国株の統合ダッシュボードを段階的に構築する。
S&P500とFANG+銘柄を追加し、ドル建て/円建て表示の切り替え機能を実装する。

**総見積もり時間**: 約10時間

---

## 開発環境

### サーバー起動コマンド

開発時は以下のコマンドでサーバーを起動します：

```bash
uv run uvicorn app:app --host 0.0.0.0 --port 8000 --reload
```

- `--reload`: ファイル変更時に自動リロード（開発時のみ）
- ポート: 8000
- アクセス: http://localhost:8000

### その他の開発コマンド

```bash
# 依存関係のインストール
uv pip install -r requirements.txt

# テスト実行
uv run pytest test_app.py

# キャッシュクリア（デバッグ用）
curl http://localhost:8000/api/cache/clear

# ヘルスチェック
curl http://localhost:8000/health
```

---

## フェーズ一覧

| フェーズ | タスク名 | 見積もり時間 | 状態 |
|---------|---------|------------|------|
| Phase 0 | mock画面の作成 | - | |
| Phase 1 | yfinanceを用いた株価データ取得 | - | |
| Phase 2 | ドル円レート取得機能の追加 | 30分 | |
| Phase 3 | S&P500インデックスの追加 | 1時間 | ⬜ 未着手 |
| Phase 4 | FANG+の追加 | 1時間 | ⬜ 未着手 |
| Phase 5 | 円建て換算表示機能 | 1.5時間 | ⬜ 未着手 |
| Phase 6 | 通貨切り替えUIの実装 | 2時間 | ⬜ 未着手 |
| Phase 7 | UIレイアウトの最適化 | 1時間 | ⬜ 未着手 |
| Phase 8 | テストとバグ修正 | 2時間 | ⬜ 未着手 |
| Phase 9 | ドキュメント更新 | 1時間 | ⬜ 未着手 |

---

## Phase 1: データ取得基盤の拡張 ✅

**状態**: 完了

**実施内容**:
- [x] yfinance 1.0にアップグレード
- [x] 10日間データ取得機能実装
- [x] 線グラフ表示実装

**成果物**:
- yfinance 1.0で安定したデータ取得
- 10日間の株価推移を線グラフで表示
- SVGベースの美しいチャート

---

## Phase 2: ドル円レート取得機能の追加 ✅

**状態**: 完了

**目的**: 為替レート（ドル円）を取得してキャッシュし、後のフェーズで通貨換算に使用できるようにする

**見積もり時間**: 30分

### タスク一覧

- [x] **タスク2-1**: `get_exchange_rate()` 関数の実装
  - **詳細**: ティッカー`USDJPY=X`からドル円レートを取得
  - **実装場所**: `app.py`
  - **成果物**: 為替レートを返す関数（エラー時は0.0またはデフォルト値）

- [x] **タスク2-2**: 為替レートのキャッシュ機構
  - **詳細**: 既存の`_cache`辞書を利用してキャッシュ
  - **キャッシュキー**: `"USDJPY=X"`
  - **TTL**: 30秒
  - **成果物**: キャッシュが正常に動作

- [x] **タスク2-3**: APIレスポンスへの為替レート追加
  - **詳細**: `/api/stocks`のレスポンスに`exchange_rate`フィールドを追加
  - **実装場所**: `app.py`の`get_stocks()`関数
  - **成果物**: APIレスポンスに為替レート情報が含まれる

- [x] **タスク2-4**: 動作確認
  - **詳細**: 為替レートが正しく取得できることを確認
  - **確認項目**:
    - [x] `get_exchange_rate()`が正常にレートを返す
    - [x] キャッシュが30秒間有効
    - [x] `/api/stocks`に`exchange_rate`フィールドが含まれる
    - [x] エラー時にデフォルト値を返す

### 完了条件

- [x] `get_exchange_rate()` 関数が実装されている
- [x] 為替レートがキャッシュされる（30秒TTL）
- [x] `/api/stocks` のレスポンスに `exchange_rate` が含まれる
- [x] エラーハンドリングが適切に実装されている

### 実装結果

**APIレスポンス例**:
```json
{
  "stocks": [...],
  "exchange_rate": 158.58,
  "timestamp": "2026-01-15T22:29:42.088550+09:00"
}
```

**ログ出力例**:
```
INFO - Fetching fresh exchange rate
INFO - Exchange rate: 158.58
INFO - Using cached exchange rate  # 30秒以内の再リクエスト時
```

### 実装例

```python
def get_exchange_rate() -> float:
    """
    ドル円の為替レートを取得（キャッシュ機能付き）

    Returns:
        float: ドル円レート（例: 147.52）
              エラー時は0.0を返す
    """
    ticker = "USDJPY=X"
    now = get_jst_now()

    # キャッシュチェック
    if is_cache_valid(ticker, now):
        logger.info(f"Using cached data for {ticker}")
        with _cache_lock:
            data, _ = _cache[ticker]
        return data.get("rate", 0.0)

    try:
        logger.info(f"Fetching fresh exchange rate")
        forex = yf.Ticker(ticker)
        hist = forex.history(period="1d")

        if hist.empty:
            logger.warning(f"No exchange rate data found")
            return 0.0

        rate = hist['Close'].iloc[-1]

        # キャッシュに保存
        rate_data = {
            "rate": rate,
            "last_update": now.strftime("%Y-%m-%d %H:%M:%S"),
            "error": False
        }
        with _cache_lock:
            _cache[ticker] = (rate_data, now)

        return rate

    except Exception as e:
        logger.error(f"Error fetching exchange rate: {e}")
        return 0.0
```

---

## Phase 3: S&P500インデックスの追加 ⬜

**目的**: S&P500指数をダッシュボードに表示

**見積もり時間**: 1時間

### タスク一覧

- [ ] **タスク3-1**: `STOCKS`辞書の拡張
  - **詳細**: データ構造を辞書形式に変更し、通貨情報を追加
  - **実装場所**: `app.py`
  - **成果物**: 新しい`STOCKS`辞書構造

- [ ] **タスク3-2**: S&P500データの追加
  - **詳細**: ティッカー`^GSPC`を追加
  - **設定**:
    ```python
    "^GSPC": {
        "name": "S&P 500",
        "currency": "USD",
        "type": "index",
        "category": "インデックス"
    }
    ```

- [ ] **タスク3-3**: `get_stock_data()`の拡張
  - **詳細**: 返り値に`currency`、`type`、`category`を追加
  - **実装場所**: `app.py`
  - **成果物**: 拡張された株価データ構造

- [ ] **タスク3-4**: UI表示の対応
  - **詳細**: USD銘柄には`$`マーク、JPY銘柄には`¥`マークを表示
  - **実装場所**: `templates/stocks_partial.html`
  - **成果物**: 通貨マークが正しく表示される

- [ ] **タスク3-5**: 動作確認
  - **確認項目**:
    - [ ] S&P500のデータが正しく取得できる
    - [ ] ドル建てで表示される
    - [ ] チャートが正しく表示される

### 完了条件

- [ ] `STOCKS`辞書が新しい構造に変更されている
- [ ] S&P500がダッシュボードに表示される
- [ ] USD銘柄に`$`マークが表示される
- [ ] 既存の日本株も正常に動作する

---

## Phase 4: FANG+の追加 ⬜

**目的**: FANG+主要銘柄をダッシュボードに追加

**見積もり時間**: 1時間

### タスク一覧

- [ ] **タスク4-1**: FANG+銘柄の選定
  - **推奨**: Apple, Microsoft, Google, Amazon, Meta, NVIDIA（6銘柄）
  - **決定事項**: 最終的な銘柄リストを確定

- [ ] **タスク4-2**: `STOCKS`辞書への追加
  - **詳細**: 6銘柄を追加
  - **実装場所**: `app.py`
  - **成果物**:
    ```python
    "AAPL": {"name": "Apple", "currency": "USD", "type": "stock", "category": "FANG+"},
    "MSFT": {"name": "Microsoft", "currency": "USD", "type": "stock", "category": "FANG+"},
    # ... 他4銘柄
    ```

- [ ] **タスク4-3**: グリッドレイアウトの調整
  - **詳細**: 9銘柄が見やすく配置されるように調整
  - **実装場所**: `templates/stocks_partial.html`
  - **変更**: `grid-cols-1 md:grid-cols-2 lg:grid-cols-3`

- [ ] **タスク4-4**: 動作確認
  - **確認項目**:
    - [ ] 全6銘柄のデータが取得できる
    - [ ] レイアウトが適切
    - [ ] パフォーマンスが許容範囲内

### 完了条件

- [ ] FANG+主要6銘柄が表示される
- [ ] 合計9銘柄すべてが正常に動作する
- [ ] レイアウトが見やすい

---

## Phase 5: 円建て換算表示機能 ⬜

**目的**: 米国株を円建てで表示できるデータ構造を準備

**見積もり時間**: 1.5時間

### タスク一覧

- [ ] **タスク5-1**: データ変換ロジックの実装
  - **詳細**: USD価格を円建てに換算する関数
  - **実装場所**: `app.py`またはJavaScript
  - **成果物**: `convert_to_jpy()`関数

- [ ] **タスク5-2**: APIレスポンスの確認
  - **詳細**: 為替レート情報が正しく含まれているか確認
  - **対象**: `/api/stocks`エンドポイント

- [ ] **タスク5-3**: クライアント側換算ロジックの準備
  - **詳細**: JavaScriptで換算計算を行う関数
  - **実装場所**: `templates/index.html`または独立したJSファイル
  - **成果物**:
    ```javascript
    function convertPrice(price, fromCurrency, toCurrency, exchangeRate) {
        if (fromCurrency === toCurrency) return price;
        if (fromCurrency === 'USD' && toCurrency === 'JPY') {
            return price * exchangeRate;
        }
        return price;
    }
    ```

- [ ] **タスク5-4**: チャートデータの換算対応
  - **詳細**: チャートの各データポイントも換算
  - **実装**: クライアント側で動的に換算

- [ ] **タスク5-5**: 動作確認
  - **確認項目**:
    - [ ] 換算計算が正しい
    - [ ] 前日比・騰落率も正しく換算される
    - [ ] チャートデータも換算される

### 完了条件

- [ ] USD→JPY換算ロジックが実装されている
- [ ] APIレスポンスに為替レート情報が含まれる
- [ ] クライアント側で換算可能な状態

---

## Phase 6: 通貨切り替えUIの実装 ⬜

**目的**: ユーザーがドル/円表示を切り替えられるUIを実装

**見積もり時間**: 2時間

### タスク一覧

- [ ] **タスク6-1**: トグルスイッチUIの追加
  - **詳細**: ヘッダー部分にUSD/JPYトグルスイッチを配置
  - **実装場所**: `templates/index.html`
  - **デザイン**: Tailwind CSSのトグルスイッチ
  - **成果物**: 動作するトグルスイッチUI

- [ ] **タスク6-2**: JavaScript状態管理
  - **詳細**: 現在の通貨表示モードを管理
  - **実装場所**: `templates/index.html`
  - **成果物**:
    ```javascript
    let currentCurrency = 'USD'; // or 'JPY'

    function toggleCurrency() {
        currentCurrency = currentCurrency === 'USD' ? 'JPY' : 'USD';
        updateAllPrices();
        savePreference();
    }
    ```

- [ ] **タスク6-3**: 価格表示の動的更新
  - **詳細**: トグル切り替え時に全銘柄の価格を再計算
  - **実装**: JavaScriptで価格、前日比、通貨マークを更新
  - **成果物**: リアルタイムで表示が切り替わる

- [ ] **タスク6-4**: ローカルストレージへの設定保存（オプション）
  - **詳細**: ユーザーの選択を記憶
  - **実装**: `localStorage.setItem('currency', currentCurrency)`

- [ ] **タスク6-5**: 動作確認
  - **確認項目**:
    - [ ] トグルスイッチが正常に動作
    - [ ] USD⇄JPY切り替えが即座に反映
    - [ ] 通貨マークが正しく表示
    - [ ] ページリロード後も設定が保持される（オプション機能実装時）

### 完了条件

- [ ] トグルスイッチで通貨表示を切り替え可能
- [ ] USD→JPY、JPY→USDの換算が正確
- [ ] 通貨マーク（$、¥）が正しく表示
- [ ] HTMX自動更新と競合しない

---

## Phase 7: UIレイアウトの最適化 ⬜

**目的**: 銘柄数増加に対応したレイアウト調整

**見積もり時間**: 1時間

### タスク一覧

- [ ] **タスク7-1**: グリッドレイアウトの最終調整
  - **詳細**: 3列表示の最適化
  - **実装場所**: `templates/stocks_partial.html`
  - **設定**: `grid-cols-1 md:grid-cols-2 lg:grid-cols-3`

- [ ] **タスク7-2**: カードサイズの最適化
  - **詳細**: 9銘柄が見やすく配置されるよう調整
  - **対象**: パディング、マージン、フォントサイズ

- [ ] **タスク7-3**: 銘柄のグルーピング（オプション）
  - **詳細**: セクションごとに分ける
  - **グループ**:
    1. 日本株（2銘柄）
    2. 米国インデックス（1銘柄）
    3. FANG+（6銘柄）

- [ ] **タスク7-4**: レスポンシブデザインの確認
  - **確認項目**:
    - [ ] モバイル（1列）で見やすい
    - [ ] タブレット（2列）で見やすい
    - [ ] デスクトップ（3列）で見やすい

- [ ] **タスク7-5**: チャートサイズの調整
  - **詳細**: 銘柄数が多くなってもチャートが見やすいサイズ

### 完了条件

- [ ] 9銘柄すべてが見やすく配置されている
- [ ] レスポンシブデザインが適切
- [ ] スクロールが必要最小限

---

## Phase 8: テストとバグ修正 ⬜

**目的**: 全機能の動作確認と品質保証

**見積もり時間**: 2時間

### タスク一覧

#### テストカテゴリ1: データ取得

- [ ] **テスト8-1-1**: ドル円レート取得
  - [ ] 正常にレートが取得できる
  - [ ] キャッシュが正常に動作
  - [ ] エラー時のフォールバック動作

- [ ] **テスト8-1-2**: S&P500データ取得
  - [ ] 正常にデータが取得できる
  - [ ] USDで表示される
  - [ ] エラー時の表示

- [ ] **テスト8-1-3**: FANG+データ取得
  - [ ] 全6銘柄が正常に取得できる
  - [ ] エラー発生時の動作

#### テストカテゴリ2: 通貨換算

- [ ] **テスト8-2-1**: USD→JPY換算
  - [ ] 価格換算が正しい
  - [ ] 前日比換算が正しい
  - [ ] 騰落率は変わらない

- [ ] **テスト8-2-2**: チャートデータ換算
  - [ ] チャート上の価格も正しく換算される

- [ ] **テスト8-2-3**: エッジケース
  - [ ] 為替レートが0の場合
  - [ ] 為替レートがNaNの場合

#### テストカテゴリ3: UI/UX

- [ ] **テスト8-3-1**: トグルスイッチ
  - [ ] クリックで正常に切り替わる
  - [ ] 表示が即座に更新される

- [ ] **テスト8-3-2**: 通貨マーク表示
  - [ ] USD銘柄に$マーク
  - [ ] JPY銘柄に¥マーク
  - [ ] 換算時も正しいマーク

- [ ] **テスト8-3-3**: HTMX自動更新
  - [ ] 30秒ごとに更新される
  - [ ] 通貨設定が保持される
  - [ ] レイアウトが崩れない

- [ ] **テスト8-3-4**: レスポンシブデザイン
  - [ ] モバイル表示が正常
  - [ ] タブレット表示が正常
  - [ ] デスクトップ表示が正常

#### テストカテゴリ4: パフォーマンス

- [ ] **テスト8-4-1**: キャッシュ動作
  - [ ] 30秒以内の再取得はキャッシュから
  - [ ] TTL経過後は新規取得

- [ ] **テスト8-4-2**: ページロード時間
  - [ ] 初回ロード: 10秒以内
  - [ ] キャッシュヒット時: 1秒以内

- [ ] **テスト8-4-3**: メモリ使用量
  - [ ] 通常運用時: 50MB以内

### バグ修正

- [ ] **発見されたバグをすべて修正**
- [ ] **修正後に再テスト**

### 完了条件

- [ ] すべてのテストがパスする
- [ ] 既知のバグがゼロ
- [ ] `test_app.py`が最新状態に更新されている

---

## Phase 9: ドキュメント更新 ⬜

**目的**: 変更内容をドキュメントに反映

**見積もり時間**: 1時間

### タスク一覧

- [ ] **タスク9-1**: `README.md`の更新
  - **追加内容**:
    - [ ] 新機能の説明（S&P500、FANG+、通貨切り替え）
    - [ ] スクリーンショットの更新（オプション）
    - [ ] 使用方法の更新

- [ ] **タスク9-2**: `CLAUDE.md`の更新
  - **追加内容**:
    - [ ] 新しいアーキテクチャの説明
    - [ ] 通貨換算ロジックの説明
    - [ ] FANG+銘柄リスト
    - [ ] 9銘柄の構成説明

- [ ] **タスク9-3**: `doc/api-spec.md`の作成（新規）
  - **内容**:
    - [ ] 全APIエンドポイントの仕様
    - [ ] リクエスト/レスポンス例
    - [ ] データ構造の詳細

- [ ] **タスク9-4**: 仕様書.mdと開発方針.mdの最終更新
  - **内容**:
    - [ ] 実装済み機能のマーク
    - [ ] 既知の問題点の記載
    - [ ] 今後の拡張予定

### 完了条件

- [ ] すべてのドキュメントが最新状態
- [ ] 新機能の使い方が明確
- [ ] 次の開発者が理解できる内容

---

## 進捗管理

### 現在の状態

- **現在のフェーズ**: Phase 3
- **進捗**: 2/9 フェーズ完了
- **完了タスク**: Phase 1, Phase 2
- **次のタスク**: Phase 3 - S&P500インデックスの追加

### マイルストーン

| マイルストーン | 対象フェーズ | 目標日 | 状態 |
|--------------|------------|--------|------|
| データ取得基盤完成 | Phase 1 | - | ✅ 完了 |
| 基本機能完成 | Phase 2-4 | - | 🔄 進行中 |
| 通貨機能完成 | Phase 5-6 | - | ⬜ 未着手 |
| 品質保証完了 | Phase 7-9 | - | ⬜ 未着手 |

---

## 開発の原則

### 1. 段階的実装
- 一度にすべてを実装しない
- 各フェーズを完了してから次へ
- 動作確認を都度実施

### 2. 仕様書への準拠
- `/doc/仕様書.md`の内容を厳守
- 不明点は実装前に確認
- 仕様変更は文書化

### 3. エラーハンドリングの徹底
- すべてのAPI呼び出しでエラー処理
- ユーザーに適切なフィードバック
- ログを適切に出力

### 4. コード品質の維持
- PEP 8に準拠（Python）
- 型ヒントの使用
- 適切なコメント
- DRY原則の遵守

### 5. テストの重要性
- 実装と並行してテスト
- エッジケースを考慮
- リグレッションを防止

---

## リスク管理

### 識別済みリスク

| リスク | 影響度 | 対策 |
|--------|--------|------|
| yfinance APIの変更 | 高 | バージョン固定、定期的な動作確認 |
| 為替レートデータ取得失敗 | 中 | デフォルト値でフォールバック |
| パフォーマンス劣化（9銘柄） | 中 | 並列取得の実装（Phase 8） |
| ブラウザ互換性 | 低 | モダンブラウザに限定 |

---

## 次のアクション


**推奨作業順序**:
- ~~Phase 2~~ → **Phase 3** → Phase 4 → Phase 5 → Phase 6 → Phase 7 → Phase 8 → Phase 9

---

## 変更履歴

